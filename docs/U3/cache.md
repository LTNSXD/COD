 # Cache

## 程序的运行局部性原理

- 在一小段**时间**内，**最近被访问过的程序和数据很可能被再次访问**
- 在**空间**上，**这些被访问的程序和数据往往集中在一小片存储区**
- 在访问顺序上，指令顺序执行比转移执行的可能性大（5:1）

- 一个例题：

![](cache/image-20231207004138064.png)

- 答案：空间，时间，空间，时间

我们考虑以下这一段代码：

```C
int sum_array_3d(int a[M][N][N]) {
  int i, j, k, sum = 0;
  for (i = 0; i < M; i++)
    for (j = 0; j < N; j++)
      for (k = 0; k < N; k++)
        sum += a[k][i][j];
  return sum;
}
```

这段代码的**局部性很差**。因为看最内层循环，k每次+1，内存都跳了很远。

可以把循环的层数调换一下，比如让j放在最内层循环。

![](cache/image-20231207004945246.png)



## 层次存储器系统

![](cache/image-20231207004411826.png)

- 使用高速缓冲存储器Cache来提高CPU对存储器的平均访问速度。
  - 将最近被访问的信息项装入到Cache中（时间局部）。
  - 将最近被访问的信息项临近的信息一起装入到Cache中（空间局部）。

## 高度缓冲存储器Cache

- 定义
  - 设置于**主存和CPU之间**的存储器，用高速的静态存储器实现，缓存了CPU频繁访问的信息。
- 特点
  - 高速：与CPU的运行速度基本匹配
  - 透明：完全硬件管理，对程序员透明（你能知道cache有多大，存了什么数吗？）

## Cache的基本运行原理

- 读：

![](cache/image-20231207013156066.png)

- Cache中还需要存地址（假如Cache有64Byte，每条数据4Byte，那实际上存不下16条数据）。

## 要解决的问题

1. 地址和Cache行之间的映射关系：

   如何根据主存地址得到Cache中的数据？

2. 数据之间一致性：

   Cache中的内容是否已经是主存对应地址的内容？

3. 数据交换的粒度：

   Cache中的内容与主存内容以多大的粒度交换？

   4Bytes，8Bytes，64Bytes？

   越大越好吗？不是，缓存大小是有限的。

4. Cache内容装入和替换策略

   如何提高Cache的命中率？

## Cache参数

- 块/行（Line）：数据交换的最小单位
- 命中（Hit）：在较高层次中要访问的内容
  - 命中率（Hit Rate）：命中次数/访问次数
  - 命中时间：访问在较高层次中数据的时间
- 缺失（Miss）：需要在较低层次中访问块
  - 缺失率（Miss Rate）：1-命中率
  - 缺失损失（Miss Penalty）：替换较高层次数据块的时间+将该块交付给处理器的时间（Dram+Sram）
- 命中时间$\ll$缺失损失
- 平均访问时间=HR*命中时间+（1-HR）\*缺失损失

## 参数典型数值

![](cache/image-20231207014016035.png)

## 全相联方式

![](cache/image-20231207014205838.png)

- 没有限制，任何数据可以出现在cache的任何地方

![](cache/image-20231207014318246.png)

- 块号：就是Tag
- 块内地址：按照字节来访问一行中的哪一位

![](cache/image-20231207014450362.png)

- 这时，块号：30位，块内地址：2位（4个Byte）

- （好好想想块号到底是什么，是**主存地址**中的前面一部分）

- 特点：

![](cache/image-20231207015156987.png)

## 直接映射方式

使用Hash的方式：

![](cache/image-20231207015345177.png)

例如，主存里是4的部分只能放在0（mod 4）的地方。

![](cache/image-20231207015433070.png)

tag的位数逐渐降低（和全相连相比）

查询过程：拿index去查，然后拿Tag去比（一样or不一样），如果一样，再看Valid与否。

## Cache举例（Direct Mapping）

![](cache/image-20231207015741149.png)

![](cache/image-20231207015704602.png)

- 解答：miss（存入0-15），miss（存入16-31），miss（存入32-47），hit，hit，hit，hit，miss（把0-15给替换），miss（把16-31给替换）
- 失效原因：启动失效/冲突失效